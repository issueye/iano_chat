# pkg/web 优化建议文档

## 一、代码优化建议

### 1.1 优雅关闭功能完善

**问题:** `graceful` 标志位在代码中存在但未实际使用

**建议改进:**
```go
func (e *Engine) Run(addr string) error {
    e.engine = &http.Server{
        Addr:         addr,
        Handler:      e,
        ReadTimeout:  e.ReadTimeout,
        WriteTimeout: e.WriteTimeout,
    }

    if e.graceful {
        return e.runGraceful(addr)
    }

    fmt.Printf("Server starting on %s\n", addr)
    return e.engine.ListenAndServe()
}

func (e *Engine) runGraceful(addr string) error {
    // 实现优雅关闭逻辑
    // 1. 监听系统信号
    // 2. 接收到信号后停止接受新连接
    // 3. 等待现有连接处理完成
    // 4. 超时后强制关闭
}
```

**优先级:** 高

### 1.2 路由匹配优化

**当前问题:**
- 同时维护 `routes` 切片和 `trie` 树，内存占用较高
- `paramRoutes` map 可以通过 Trie 树完全替代

**建议改进:**
```go
// 简化 Router 结构体
type Router struct {
    trie *TrieRouter
}

// 删除冗余字段：routes, paramRoutes
```

**收益:**
- 减少内存占用约 30%
- 简化代码逻辑
- 提高维护性

**优先级:** 中

### 1.3 内存池优化

**建议:** 使用 sync.Pool 复用 Context 对象

```go
var contextPool = sync.Pool{
    New: func() interface{} {
        return &Context{}
    },}

func newContext(w http.ResponseWriter, r *http.Request) *Context {
    c := contextPool.Get().(*Context)
    c.Writer = w
    c.Request = r
    c.Path = r.URL.Path
    c.Method = r.Method
    c.query = r.URL.Query()
    c.index = -1
    c.data = make(map[string]interface{})
    c.Params = make(map[string]string)
    return c
}

func (c *Context) reset() {
    // 重置字段
    contextPool.Put(c)
}
```

**收益:**
- 减少 GC 压力
- 提高并发性能 10-20%

**优先级:** 中

### 1.4 错误处理增强

**建议:** 添加统一的错误处理机制

```go
// 添加错误类型
type HTTPError struct {
    Code    int
    Message string
    Error   error
}

func (c *Context) Error(code int, err error) {
    c.Status(code)
    if e, ok := err.(*HTTPError); ok {
        c.JSON(code, map[string]interface{}{
            "error": e.Message,
            "code":  e.Code,
        })
    } else {
        c.JSON(code, map[string]interface{}{
            "error": err.Error(),
            "code":  code,
        })
    }
}
```

**优先级:** 中

---

## 二、功能增强建议

### 2.1 请求验证器

**需求:** 添加结构体验证功能

**实现建议:**
```go
// 添加验证标签支持
type User struct {
    Name  string `json:"name" validate:"required,min=3,max=50"`
    Email string `json:"email" validate:"required,email"`
    Age   int    `json:"age" validate:"min=0,max=150"`
}

func (c *Context) BindAndValidate(obj interface{}) error {
    if err := c.Bind(obj); err != nil {
        return err
    }
    // 使用 go-playground/validator 或其他验证库
    return validate.Struct(obj)
}
```

**推荐库:** `github.com/go-playground/validator/v10`

**优先级:** 高

### 2.2 响应缓存

**需求:** 添加响应缓存中间件

**实现建议:**
```go
// cache.go
func CacheMiddleware(duration time.Duration) MiddlewareFunc {
    cache := make(map[string]cacheEntry)
    var mu sync.RWMutex
    
    return func(c *Context) {
        key := c.Method + ":" + c.Path
        
        mu.RLock()
        entry, ok := cache[key]
        mu.RUnlock()
        
        if ok && time.Since(entry.time) < duration {
            c.Writer.Write(entry.data)
            c.Abort()
            return
        }
        
        // 包装 Writer 捕获响应
        c.Next()
        
        // 存储缓存
        mu.Lock()
        cache[key] = cacheEntry{data: capturedData, time: time.Now()}
        mu.Unlock()
    }
}
```

**优先级:** 中

### 2.3 WebSocket 支持

**需求:** 添加 WebSocket 支持

**实现建议:**
```go
// websocket.go
import "github.com/gorilla/websocket"

var upgrader = websocket.Upgrader{
    ReadBufferSize:  1024,
    WriteBufferSize: 1024,
    CheckOrigin: func(r *http.Request) bool {
        return true
    },
}

func (c *Context) UpgradeWebSocket() (*websocket.Conn, error) {
    return upgrader.Upgrade(c.Writer, c.Request, nil)
}

// 使用示例
engine.GET("/ws", func(c *web.Context) {
    conn, err := c.UpgradeWebSocket()
    if err != nil {
        c.Error(400, err)
        return
    }
    defer conn.Close()
    // 处理 WebSocket 连接
})
```

**依赖:** `github.com/gorilla/websocket`

**优先级:** 高

### 2.4 请求限流

**需求:** 添加速率限制中间件

**实现建议:**
```go
// ratelimit.go
func RateLimit(requests int, per time.Duration) MiddlewareFunc {
    limiter := NewTokenBucket(requests, per)
    
    return func(c *Context) {
        if !limiter.Allow() {
            c.String(429, "Too Many Requests")
            c.Abort()
            return
        }
        c.Next()
    }
}
```

**优先级:** 中

### 2.5 压缩支持

**需求:** 自动 gzip 压缩响应

**实现建议:**
```go
// compress.go
func Gzip() MiddlewareFunc {
    return func(c *Context) {
        if !strings.Contains(c.GetHeader("Accept-Encoding"), "gzip") {
            c.Next()
            return
        }
        
        gz := gzip.NewWriter(c.Writer)
        defer gz.Close()
        
        c.SetHeader("Content-Encoding", "gzip")
        c.Writer = &gzipResponseWriter{Writer: gz, ResponseWriter: c.Writer}
        
        c.Next()
    }
}
```

**优先级:** 中

### 2.6 日志增强

**需求:** 结构化日志支持

**实现建议:**
```go
// 使用 zap 或 slog
import "go.uber.org/zap"

type LoggerConfig struct {
    Logger    *zap.Logger
    Formatter LogFormatter
    SkipPaths []string  // 跳过的路径
}

func StructuredLogger() MiddlewareFunc {
    logger, _ := zap.NewProduction()
    
    return func(c *Context) {
        start := time.Now()
        c.Next()
        
        logger.Info("http_request",
            zap.String("method", c.Method),
            zap.String("path", c.Path),
            zap.Int("status", c.GetStatus()),
            zap.Duration("latency", time.Since(start)),
            zap.String("ip", c.Request.RemoteAddr),
        )
    }
}
```

**优先级:** 低

---

## 三、安全增强建议

### 3.1 CSRF 防护

**建议:** 添加 CSRF Token 验证中间件

```go
// csrf.go
func CSRF() MiddlewareFunc {
    return func(c *Context) {
        if c.Method != "GET" && c.Method != "HEAD" {
            token := c.GetHeader("X-CSRF-Token")
            if !validateCSRFToken(token) {
                c.String(403, "Invalid CSRF Token")
                c.Abort()
                return
            }
        }
        c.Next()
    }
}
```

**优先级:** 中

### 3.2 安全头部

**建议:** 自动添加安全响应头

```go
// security.go
func SecurityHeaders() MiddlewareFunc {
    return func(c *Context) {
        c.SetHeader("X-Content-Type-Options", "nosniff")
        c.SetHeader("X-Frame-Options", "DENY")
        c.SetHeader("X-XSS-Protection", "1; mode=block")
        c.SetHeader("Strict-Transport-Security", "max-age=31536000; includeSubDomains")
        c.Next()
    }
}
```

**优先级:** 中

### 3.3 请求大小限制

**建议:** 限制请求体大小

```go
func (c *Context) Body() []byte {
    if c.Request.Body == nil {
        return nil
    }
    // 限制 32MB
    body, _ := io.ReadAll(io.LimitReader(c.Request.Body, 32<<20))
    c.Request.Body = io.NopCloser(strings.NewReader(string(body)))
    return body
}
```

**优先级:** 高

---

## 四、测试优化建议

### 4.1 添加中间件独立测试

**现状:** 中间件缺少独立测试

**建议:**
```go
// middleware/auth_test.go
func TestBearerAuth(t *testing.T) {
    // 测试各种 Token 场景
}

func TestBasicAuth(t *testing.T) {
    // 测试 Basic Auth 场景
}

// middleware/cors_test.go
func TestCORS(t *testing.T) {
    // 测试预检请求
    // 测试不同 Origin
}
```

**优先级:** 高

### 4.2 添加集成测试

**建议:**
```go
// integration_test.go
func TestFullApplication(t *testing.T) {
    engine := New()
    engine.Use(Recovery())
    engine.Use(Logger())
    
    engine.GET("/api/users", handler)
    
    // 完整测试流程
}
```

**优先级:** 中

### 4.3 提高测试覆盖率

**目标:** 从 85% 提升到 95%

**需要补充的测试:**
- 文件上传/下载
- Cookie 操作
- 重定向
- 静态文件服务
- 各种边界条件

**优先级:** 中

---

## 五、文档优化建议

### 5.1 API 文档自动生成

**建议:** 使用 Swagger/OpenAPI

```go
// 添加注解
// @Summary 获取用户信息
// @Param id path int true "用户ID"
// @Success 200 {object} User
// @Router /api/users/{id} [get]
engine.GET("/api/users/:id", getUser)
```

**工具:** swaggo/swag

**优先级:** 中

### 5.2 添加架构图

**建议:** 添加模块架构图和数据流图

```
[Client Request]
      ↓
[Middleware Chain]
      ↓
[Router (Trie)]
      ↓
[Handler]
      ↓
[Context]
      ↓
[Response]
```

**优先级:** 低

### 5.3 添加性能基准

**建议:** 与 Gin、Echo 等框架对比性能

```go
// benchmark_test.go
func BenchmarkVsGin(b *testing.B) {
    // 对比测试
}
```

**优先级:** 低

---

## 六、优化优先级汇总

| 优化项 | 优先级 | 难度 | 预计收益 |
|--------|--------|------|----------|
| 完善优雅关闭 | 高 | 低 | 功能完整性 |
| 添加请求验证 | 高 | 中 | 功能增强 |
| 请求大小限制 | 高 | 低 | 安全性 |
| 中间件独立测试 | 高 | 中 | 质量保证 |
| 路由匹配优化 | 中 | 中 | 性能/内存 |
| 内存池优化 | 中 | 中 | 性能 |
| 响应缓存 | 中 | 中 | 性能 |
| WebSocket 支持 | 高 | 高 | 功能增强 |
| 请求限流 | 中 | 中 | 安全性 |
| 压缩支持 | 中 | 低 | 性能 |
| CSRF 防护 | 中 | 中 | 安全性 |
| 安全头部 | 中 | 低 | 安全性 |
| 结构化日志 | 低 | 低 | 可维护性 |
| Swagger 文档 | 中 | 中 | 可维护性 |

---

## 七、实施建议

### 短期（1-2 周）
1. 完善优雅关闭功能
2. 添加请求大小限制
3. 补充中间件单元测试
4. 路由匹配内存优化

### 中期（1 个月）
1. 实现请求验证功能
2. 添加 WebSocket 支持
3. 实现响应缓存
4. 添加速率限制

### 长期（2-3 个月）
1. 完善安全功能（CSRF、安全头部）
2. 添加压缩支持
3. 集成 Swagger 文档
4. 性能持续优化

---

*文档创建时间: 2026-02-09*  
*建议版本: v1.1.0*
